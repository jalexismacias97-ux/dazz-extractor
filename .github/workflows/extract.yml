name: Extractor V6 (M√©todo Python en Mac)

on: [push]

jobs:
  extract_assets_python:
    runs-on: macos-latest

    steps:
      - name: 1. Descargar Tu Repositorio
        uses: actions/checkout@v3

      - name: 2. Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      - name: 3. Instalar librer√≠as necesarias
        run: |
          # Instalamos la librer√≠a que lee archivos .car
          pip install acefile
          # Intentamos instalar soporte para compresi√≥n LZFSE (nativa de Apple)
          pip install python-lzfse || true 

      - name: 4. üîç Localizar Assets.car
        id: find_file
        run: |
          FILE=$(find . -maxdepth 3 -type f -name "[Aa]ssets.car" | head -n 1)
          if [ -z "$FILE" ]; then
             echo "‚ùå ERROR: No encuentro Assets.car"
             ls -R
             exit 1
          fi
          echo "FILE_PATH=$FILE" >> $GITHUB_ENV
          echo "‚úÖ Archivo encontrado: $FILE"

      - name: 5. üêç Ejecutar Script de Extracci√≥n
        run: |
          # Creamos un peque√±o script de Python ah√≠ mismo para hacer el trabajo
          cat <<EOF > script_extractor.py
          import acefile
          import os
          import sys

          input_car = "${{ env.FILE_PATH }}"
          output_dir = "output_images"

          print(f"Abriendo: {input_car}")

          try:
              os.makedirs(output_dir, exist_ok=True)
              with open(input_car, 'rb') as f:
                  catalog = acefile.ACECatalog.parse(f.read())
                  
                  print(f"Encontrados {len(catalog.assets)} recursos.")
                  count = 0
                  for asset in catalog.assets:
                      # Intentamos guardar solo im√°genes
                      try:
                          # Generamos un nombre
                          name = asset.name if asset.name else f"asset_{count}"
                          # Limpiamos caracteres raros
                          name = name.replace("/", "_")
                          
                          # Detectamos extensi√≥n b√°sica
                          ext = ".png"
                          if asset.uti == "public.jpeg": ext = ".jpg"
                          
                          full_path = os.path.join(output_dir, name + ext)
                          
                          with open(full_path, 'wb') as out:
                              out.write(asset.data)
                          count += 1
                      except Exception as e:
                          print(f"Saltando un asset: {e}")
                          
                  print(f"--- √âXITO: {count} im√°genes extra√≠das ---")

          except Exception as e:
              print(f"ERROR CR√çTICO: {e}")
              sys.exit(1)
          EOF

          # Ejecutamos el script que acabamos de crear
          python script_extractor.py

      - name: 6. üì¶ Subir Resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Filtros-Python-Extracted
          path: output_images/
