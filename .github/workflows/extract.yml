name: Extractor V9 (El Tanque)

on: [push]

jobs:
  extract_assets:
    runs-on: macos-latest

    steps:
      - name: 1. Descargar Tu Repositorio
        uses: actions/checkout@v3

      - name: 2. ðŸ›  Descargar Herramienta (Fuerza Bruta)
        run: |
          echo "Intentando descargar ZIP..."
          # Usamos la URL corta que redirige automÃ¡ticamente al archivo correcto
          curl -L -o tool.zip "https://github.com/0xced/cartool/archive/master.zip"
          
          # DIAGNÃ“STICO: Verificamos cuÃ¡nto pesa el archivo
          SIZE=$(wc -c < tool.zip | xargs)
          echo "El archivo descargado pesa: $SIZE bytes"
          
          # Si pesa menos de 1000 bytes, es un error de texto (como el 404)
          if [ "$SIZE" -lt 1000 ]; then
            echo "âŒ ERROR: La descarga fallÃ³. Contenido del archivo:"
            cat tool.zip
            exit 1
          fi
          
          echo "âœ… Descarga vÃ¡lida. Descomprimiendo..."
          unzip -q tool.zip
          
          # Renombramos la carpeta sea cual sea su nombre
          mv cartool-master cartool || mv cartool-main cartool

      - name: 3. ðŸ”¨ Compilar Herramienta
        run: |
          cd cartool
          xcodebuild -scheme cartool -configuration Release

      - name: 4. ðŸ” Localizar Assets.car
        id: find_file
        run: |
          # Buscamos tu archivo
          FILE=$(find . -maxdepth 3 -type f -name "[Aa]ssets.car" | head -n 1)
          
          if [ -z "$FILE" ]; then
            echo "âŒ ERROR: No encuentro Assets.car"
            echo "Listado de archivos:"
            ls -R
            exit 1
          fi
          
          echo "found_file=$FILE" >> $GITHUB_OUTPUT
          echo "âœ… Archivo encontrado: $FILE"

      - name: 5. ðŸš€ EJECUTAR EXTRACCIÃ“N
        run: |
          mkdir output_images
          FILE="${{ steps.find_file.outputs.found_file }}"
          
          echo "Extrayendo..."
          ./cartool/build/Release/cartool "$FILE" output_images/

      - name: 6. ðŸ“¦ Subir Resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Filtros-Finales-V9
          path: output_images/
