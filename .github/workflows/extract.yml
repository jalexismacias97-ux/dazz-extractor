name: Extractor V22 (Inyecci√≥n de C√≥digo Total)

on: [push]

jobs:
  extract_assets:
    runs-on: macos-latest

    steps:
      - name: 1. Descargar Tu Repositorio
        uses: actions/checkout@v3

      - name: 2. üèóÔ∏è Crear el c√≥digo del extractor
        run: |
          # Vamos a crear el archivo main.m 'de la nada' con el c√≥digo fuente
          # Esto elimina la necesidad de descargar herramientas externas.
          
          cat <<EOF > main.m
          #import <Foundation/Foundation.h>
          #import <CoreGraphics/CoreGraphics.h>
          #import <ImageIO/ImageIO.h>

          // Definiciones para enga√±ar al compilador y usar APIs privadas
          @interface CUICommonAssetStorage : NSObject
          -(instancetype)initWithPath:(NSString *)p;
          -(NSArray *)allAssetKeys;
          -(NSArray *)allRenditionNames;
          @end

          @interface CUICatalog : NSObject
          -(instancetype)initWithURL:(NSURL *)url error:(NSError **)error;
          -(id)allImageNames;
          -(NSArray *)imagesWithName:(NSString *)n;
          @end

          @interface CUIStructuredThemeStore : NSObject
          -(instancetype)initWithURL:(NSURL *)url error:(NSError **)error;
          @end

          @interface CUIThemeRendition : NSObject
          -(NSString *)name;
          -(CGImageRef)uncroppedImage;
          -(NSData *)data;
          @end

          int main(int argc, const char * argv[]) {
              @autoreleasepool {
                  if (argc < 3) {
                      printf("Uso: ./extractor <archivo.car> <carpeta_destino>\n");
                      return 1;
                  }

                  NSString *carPath = [NSString stringWithUTF8String:argv[1]];
                  NSString *outputDir = [NSString stringWithUTF8String:argv[2]];
                  
                  // Crear carpeta destino
                  [[NSFileManager defaultManager] createDirectoryAtPath:outputDir withIntermediateDirectories:YES attributes:nil error:nil];

                  printf("Abriendo: %s\n", [carPath UTF8String]);
                  
                  NSError *error = nil;
                  // Cargar la librer√≠a privada CoreUI
                  NSBundle *bundle = [NSBundle bundleWithPath:@"/System/Library/PrivateFrameworks/CoreUI.framework"];
                  [bundle load];

                  // Intentar abrir el cat√°logo
                  NSURL *url = [NSURL fileURLWithPath:carPath];
                  CUICatalog *catalog = [[NSClassFromString(@"CUICatalog") alloc] initWithURL:url error:&error];

                  if (!catalog) {
                      printf("Error abriendo el .car: %s\n", [[error description] UTF8String]);
                      return 1;
                  }

                  // Obtener nombres de im√°genes
                  NSArray *names = [catalog allImageNames];
                  printf("Encontradas %lu im√°genes.\n", (unsigned long)[names count]);

                  for (NSString *name in names) {
                      @try {
                          // Obtener todas las variantes de esa imagen
                          NSArray *images = [catalog imagesWithName:name];
                          
                          for (id rendition in images) {
                              // Extraer CGImage (mapa de bits)
                              if ([rendition respondsToSelector:@selector(uncroppedImage)]) {
                                  CGImageRef imageRef = [rendition uncroppedImage];
                                  if (imageRef) {
                                      NSString *cleanName = [name stringByReplacingOccurrencesOfString:@"/" withString:@"_"];
                                      NSString *fileName = [NSString stringWithFormat:@"%@/%@.png", outputDir, cleanName];
                                      
                                      NSURL *fileURL = [NSURL fileURLWithPath:fileName];
                                      CGImageDestinationRef destination = CGImageDestinationCreateWithURL((__bridge CFURLRef)fileURL, kUTTypePNG, 1, NULL);
                                      
                                      if (destination) {
                                          CGImageDestinationAddImage(destination, imageRef, nil);
                                          if (CGImageDestinationFinalize(destination)) {
                                              printf("Exportado: %s\n", [cleanName UTF8String]);
                                          }
                                          CFRelease(destination);
                                      }
                                  }
                              }
                          }
                      } @catch (NSException *exception) {
                          printf("Error con %s\n", [name UTF8String]);
                      }
                  }
              }
              return 0;
          }
          EOF

      - name: 3. üî® Compilar Herramienta
        run: |
          echo "Compilando extractor..."
          # Usamos clang directamente. Sin xcodebuild, sin proyectos complejos.
          # Linkeamos contra las librer√≠as privadas necesarias.
          
          clang -o extractor main.m -fobjc-arc -framework Foundation -framework CoreGraphics -framework ImageIO -F /System/Library/PrivateFrameworks -framework CoreUI

      - name: 4. üîç Localizar y Extraer
        run: |
          # Buscar tu archivo .car
          FILE=$(find . -maxdepth 3 -type f -name "[Aa]ssets.car" | head -n 1)
          
          if [ -z "$FILE" ]; then
            echo "‚ùå ERROR: No encuentro Assets.car"
            ls -R
            exit 1
          fi
          
          echo "‚úÖ Archivo encontrado: $FILE"
          
          # EJECUTAR NUESTRO PROGRAMA
          ./extractor "$FILE" output_images/

      - name: 5. üì¶ Subir Resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Filtros-Dazz-Extraidos
          path: output_images/
