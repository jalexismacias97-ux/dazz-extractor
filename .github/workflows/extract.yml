name: Extractor V14 (VÃ­a API)

on: [push]

jobs:
  extract_assets:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: 1. Descargar Tu Repositorio
        uses: actions/checkout@v3

      - name: 2. ðŸ›  Descargar Cartool (VÃ­a API)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Solicitando cÃ³digo a la API de GitHub..."
          
          # Usamos la API para pedir el ZIP (zipball).
          # Esto es mucho mÃ¡s estable que git clone.
          curl -L \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -o cartool.zip \
            https://api.github.com/repos/0xced/cartool/zipball/master
          
          # Verificamos tamaÃ±o (para evitar el error de 9 bytes)
          SIZE=$(wc -c < cartool.zip | xargs)
          echo "TamaÃ±o del archivo: $SIZE bytes"
          
          if [ "$SIZE" -lt 1000 ]; then
            echo "âŒ ERROR: La API rechazÃ³ la descarga."
            cat cartool.zip
            exit 1
          fi

          echo "âœ… Descarga correcta. Descomprimiendo..."
          unzip -q cartool.zip
          
          # Al bajar por API, la carpeta tiene un nombre raro con el hash (ej. 0xced-cartool-a1b2c3)
          # La buscamos y la renombramos
          DIR_NAME=$(find . -maxdepth 1 -type d -name "*cartool*" | head -n 1)
          mv "$DIR_NAME" cartool

      - name: 3. ðŸ”¨ Compilar Herramienta
        run: |
          cd cartool
          echo "Compilando..."
          xcodebuild -scheme cartool -configuration Release

      - name: 4. ðŸ” Localizar Assets.car
        id: find_file
        run: |
          # Buscamos tu archivo donde sea
          FILE=$(find . -maxdepth 3 -type f -name "[Aa]ssets.car" | head -n 1)
          
          if [ -z "$FILE" ]; then
            echo "âŒ ERROR: No encuentro Assets.car"
            ls -R
            exit 1
          fi
          
          echo "found_file=$FILE" >> $GITHUB_OUTPUT
          echo "âœ… Archivo encontrado: $FILE"

      - name: 5. ðŸš€ EJECUTAR EXTRACCIÃ“N
        run: |
          mkdir output_images
          FILE="${{ steps.find_file.outputs.found_file }}"
          
          echo "Extrayendo $FILE..."
          ./cartool/build/Release/cartool "$FILE" output_images/

      - name: 6. ðŸ“¦ Subir Resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Filtros-Dazz-Final
          path: output_images/
