name: Extractor V25 (Modo RAW DATA)

on: [push]

jobs:
  extract_assets:
    runs-on: macos-latest

    steps:
      - name: 1. Descargar Tu Repositorio
        uses: actions/checkout@v3

      - name: 2. üèóÔ∏è Crear el c√≥digo del extractor
        run: |
          cat <<EOF > main.m
          #import <Foundation/Foundation.h>
          #import <CoreGraphics/CoreGraphics.h>
          #import <CoreServices/CoreServices.h>

          // Interfaces privadas necesarias
          @interface CUICatalog : NSObject
          -(instancetype)initWithURL:(NSURL *)url error:(NSError **)error;
          -(id)allImageNames;
          -(NSArray *)imagesWithName:(NSString *)n;
          @end

          // Aqu√≠ est√° la clave: CUIThemeRendition tiene m√©todos para sacar DATA
          @interface CUIThemeRendition : NSObject
          -(NSString *)name;
          -(NSData *)data;       // M√©todo para datos crudos
          -(id)csiData;          // M√©todo alternativo para estructura interna
          -(CGImageRef)uncroppedImage;
          @end

          int main(int argc, const char * argv[]) {
              @autoreleasepool {
                  if (argc < 3) return 1;

                  NSString *carPath = [NSString stringWithUTF8String:argv[1]];
                  NSString *outputDir = [NSString stringWithUTF8String:argv[2]];
                  
                  [[NSFileManager defaultManager] createDirectoryAtPath:outputDir withIntermediateDirectories:YES attributes:nil error:nil];

                  printf("--- MODO RAW DATA ---\n");
                  
                  NSBundle *bundle = [NSBundle bundleWithPath:@"/System/Library/PrivateFrameworks/CoreUI.framework"];
                  [bundle load];

                  NSURL *url = [NSURL fileURLWithPath:carPath];
                  id catalog = [[NSClassFromString(@"CUICatalog") alloc] initWithURL:url error:nil];

                  if (!catalog) {
                      printf("‚ùå Error abriendo cat√°logo.\n");
                      return 1;
                  }

                  NSArray *names = [catalog allImageNames];
                  int exportedCount = 0;

                  for (NSString *name in names) {
                      // Limpiar nombre
                      NSString *cleanName = [name stringByReplacingOccurrencesOfString:@"/" withString:@"_"];
                      printf("Procesando: %s ... ", [cleanName UTF8String]);
                      
                      @try {
                          NSArray *renditions = [catalog imagesWithName:name];
                          if (!renditions || [renditions count] == 0) {
                              printf("Vac√≠o.\n");
                              continue;
                          }

                          id rendition = renditions[0];
                          BOOL saved = NO;

                          // ESTRATEGIA 1: Intentar sacar el bloque de datos crudo (CSIData)
                          // Esto suele contener el LUT comprimido
                          if ([rendition respondsToSelector:@selector(csiData)]) {
                              NSData *rawData = [rendition csiData];
                              if (rawData && [rawData length] > 0) {
                                  NSString *fileName = [NSString stringWithFormat:@"%@/%@.csi", outputDir, cleanName];
                                  [rawData writeToFile:fileName atomically:YES];
                                  printf("‚úÖ Guardado (.csi) - %lu bytes\n", (unsigned long)[rawData length]);
                                  saved = YES;
                              }
                          }

                          // ESTRATEGIA 2: Si falla, intentar 'data' gen√©rico
                          if (!saved && [rendition respondsToSelector:@selector(data)]) {
                              NSData *rawData = [rendition data];
                              if (rawData && [rawData length] > 0) {
                                  NSString *fileName = [NSString stringWithFormat:@"%@/%@.bin", outputDir, cleanName];
                                  [rawData writeToFile:fileName atomically:YES];
                                  printf("‚úÖ Guardado (.bin) - %lu bytes\n", (unsigned long)[rawData length]);
                                  saved = YES;
                              }
                          }
                          
                          if (!saved) printf("‚ö†Ô∏è No se encontraron datos extra√≠bles.\n");
                          else exportedCount++;

                      } @catch (NSException *e) {
                          printf("Error.\n");
                      }
                  }
              }
              return 0;
          }
          EOF

      - name: 3. üî® Compilar
        run: |
          clang -o extractor main.m -fobjc-arc \
            -framework Foundation \
            -framework CoreGraphics \
            -framework CoreServices \
            -F /System/Library/PrivateFrameworks \
            -framework CoreUI

      - name: 4. üöÄ Extraer
        run: |
          FILE=$(find . -maxdepth 3 -type f -name "[Aa]ssets.car" | head -n 1)
          ./extractor "$FILE" output_images/

      - name: 5. üì¶ Subir Resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Datos-Crudos-Dazz
          path: output_images/
