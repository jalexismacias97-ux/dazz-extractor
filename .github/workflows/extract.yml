name: Extractor V18 (Nativo de Apple)

on: [push]

jobs:
  extract_assets_apple:
    runs-on: macos-latest

    steps:
      - name: 1. Descargar Tu Repositorio
        uses: actions/checkout@v3

      - name: 2. ðŸ” Localizar Assets.car
        id: find_file
        run: |
          FILE=$(find . -maxdepth 3 -type f -name "[Aa]ssets.car" | head -n 1)
          if [ -z "$FILE" ]; then
            echo "âŒ ERROR: No encuentro Assets.car"
            exit 1
          fi
          echo "found_file=$FILE" >> $GITHUB_OUTPUT
          echo "âœ… Archivo encontrado: $FILE"

      - name: 3. ðŸ Usar assetutil (Info)
        run: |
          FILE="${{ steps.find_file.outputs.found_file }}"
          
          echo "Analizando estructura con herramienta oficial..."
          # Esto nos dirÃ¡ si el archivo estÃ¡ corrupto o es vÃ¡lido
          xcrun assetutil --info "$FILE" > info.json
          
          echo "Primeras 20 lÃ­neas del JSON:"
          head -n 20 info.json

      - name: 4. ðŸ›  INTENTO DE RESCATE (AceExtractor Swift)
        run: |
          # Si cartool fallÃ³, probamos una herramienta Swift mÃ¡s moderna
          # que suele manejar mejor los formatos nuevos
          
          echo "Clonando AceExtractor (Swift)..."
          git clone https://github.com/1024jp/AceExtractor.git ace_tool
          
          cd ace_tool
          echo "Compilando con Swift..."
          swift build -c release
          
          # Buscamos el ejecutable
          ACE_BIN=$(swift build -c release --show-bin-path)/ace-extractor
          
          echo "Ejecutando AceExtractor..."
          mkdir ../output_images
          FILE="../${{ steps.find_file.outputs.found_file }}"
          
          "$ACE_BIN" "$FILE" ../output_images/

      - name: 5. ðŸ“¦ Subir Resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Filtros-Dazz-Swift
          path: output_images/
