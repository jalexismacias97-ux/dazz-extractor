name: Extractor V21 (Sintaxis Corregida)

on: [push]

jobs:
  extract_assets:
    runs-on: macos-latest

    steps:
      - name: 1. Descargar Archivos del Repo
        uses: actions/checkout@v3

      - name: 2. Preparar, Compilar y Extraer
        run: |
          # --- ZONA DE CONFIGURACI√ìN ---
          TOOL_ZIP="tool.zip"
          OUTPUT_DIR="output_images"
          mkdir -p "$OUTPUT_DIR"
          
          # 1. VERIFICAR ARCHIVOS
          echo "üîç Buscando archivos..."
          
          # Buscar Assets.car (may√∫scula o min√∫scula)
          CAR_FILE=$(find . -maxdepth 2 -name "[Aa]ssets.car" | head -n 1)
          
          if [ -z "$CAR_FILE" ]; then
            echo "‚ùå ERROR: No encuentro el archivo Assets.car en tu repositorio."
            echo "Aseg√∫rate de haberlo subido."
            exit 1
          fi
          echo "‚úÖ Encontrado: $CAR_FILE"

          if [ ! -f "$TOOL_ZIP" ]; then
            echo "‚ùå ERROR: No encuentro tool.zip."
            echo "Por favor descarga el ZIP, ll√°malo tool.zip y s√∫belo al repo."
            exit 1
          fi
          echo "‚úÖ Encontrado: $TOOL_ZIP"

          # 2. DESCOMPRIMIR HERRAMIENTA
          echo "üõ† Descomprimiendo herramienta..."
          unzip -q "$TOOL_ZIP"
          
          # Detectar nombre de la carpeta (suele ser cartool-master)
          TOOL_DIR=$(find . -maxdepth 1 -type d -name "cartool*" | head -n 1)
          mv "$TOOL_DIR" tool_src
          
          # 3. PARCHE DE C√ìDIGO (Para que compile en Macs nuevas)
          if [ -f "tool_src/cartool/main.m" ]; then
             echo "üíâ Aplicando parche de c√≥digo..."
             sed -i '' '1s/^/#import <ImageIO\/ImageIO.h>\n/' tool_src/cartool/main.m
          fi

          # 4. COMPILAR
          echo "üî® Compilando..."
          cd tool_src
          xcodebuild -scheme cartool -configuration Release > /dev/null
          cd ..
          
          # 5. BUSCAR EL EJECUTABLE GENERADO
          # Buscamos el archivo 'cartool' dentro de la carpeta tool_src
          TOOL_BIN=$(find tool_src -type f -name "cartool" -perm +0111 | grep "Release" | head -n 1)
          
          if [ -z "$TOOL_BIN" ]; then
             echo "‚ùå ERROR DE COMPILACI√ìN: No se gener√≥ el ejecutable."
             exit 1
          fi
          
          echo "‚úÖ Herramienta lista en: $TOOL_BIN"

          # 6. EJECUTAR EXTRACCI√ìN
          echo "üöÄ EXTRAYENDO IM√ÅGENES..."
          "$TOOL_BIN" "$CAR_FILE" "$OUTPUT_DIR/"
          
          echo "--- PROCESO TERMINADO ---"
          ls -l "$OUTPUT_DIR/" | head -n 10

      - name: 3. Subir ZIP Final
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Filtros-Finales
          path: output_images/
