name: Extract Assets (Modo Seguro)

on: [push]

jobs:
  extract_assets:
    runs-on: macos-latest  # Usamos la √∫ltima versi√≥n para evitar problemas de compatibilidad

    steps:
      - name: 1. Descargar tu repositorio
        uses: actions/checkout@v3

      - name: 2. üîç Verificar d√≥nde est√° el archivo
        run: |
          echo "Buscando Assets.car..."
          find . -maxdepth 2 -name "*.car"
          # Esto nos mostrar√° si el archivo se llama assets.car, Assets.car, o si est√° en una carpeta

      - name: 3. üõ† Descargar herramienta (M√©todo ZIP)
        run: |
          # En lugar de git clone (que te dio error 128), bajamos el ZIP directo
          curl -L https://github.com/0xced/cartool/archive/refs/heads/master.zip -o cartool.zip
          unzip -q cartool.zip
          mv cartool-master cartool

      - name: 4. üî® Compilar herramienta
        run: |
          cd cartool
          xcodebuild -scheme cartool -configuration Release

      - name: 5. üöÄ EJECUTAR EXTRACCI√ìN
        run: |
          mkdir output_images
          
          # Intentamos encontrar el archivo sin importar may√∫sculas/min√∫sculas
          FILE=$(find . -maxdepth 1 -iname "assets.car" | head -n 1)
          
          if [ -z "$FILE" ]; then
            echo "‚ùå ERROR FATAL: No encuentro el archivo Assets.car en la ra√≠z."
            echo "Estos son los archivos que hay en tu repo:"
            ls -la
            exit 1
          else
            echo "‚úÖ Archivo encontrado: $FILE"
            # Ejecutamos la herramienta
            ./cartool/build/Release/cartool "$FILE" output_images/
          fi

      - name: 6. üì¶ Subir lo que encontramos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Filtros-Finales
          path: output_images/
