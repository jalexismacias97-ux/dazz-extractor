name: Extractor V16 (Con Parche de CÃ³digo)

on: [push]

jobs:
  extract_assets:
    runs-on: macos-latest

    steps:
      - name: 1. Descargar Tu Repositorio
        uses: actions/checkout@v3

      - name: 2. ðŸ›  Clonar Herramienta
        run: |
          git config --global --unset credential.helper || true
          git clone https://github.com/steventroughtonSmith/cartool.git tool_src

      - name: 3. ðŸ’‰ APLICAR PARCHE (Arreglar el error de compilaciÃ³n)
        run: |
          cd tool_src/cartool
          
          # El error es que falta importar <ImageIO/ImageIO.h> en main.m
          # Vamos a insertar esa lÃ­nea al principio del archivo
          
          sed -i '' '1s/^/#import <ImageIO\/ImageIO.h>\n/' main.m
          
          echo "Parche aplicado. Primeras lÃ­neas de main.m:"
          head -n 5 main.m

      - name: 4. ðŸ”¨ Compilar Herramienta
        run: |
          cd tool_src
          # Compilamos
          xcodebuild -scheme cartool -configuration Release

      - name: 5. ðŸ” Localizar Assets.car
        id: find_file
        run: |
          FILE=$(find . -maxdepth 3 -type f -name "[Aa]ssets.car" | head -n 1)
          if [ -z "$FILE" ]; then
            echo "âŒ ERROR: No encuentro Assets.car"
            ls -R
            exit 1
          fi
          echo "found_file=$FILE" >> $GITHUB_OUTPUT
          echo "âœ… Archivo encontrado: $FILE"

      - name: 6. ðŸš€ EJECUTAR EXTRACCIÃ“N
        run: |
          mkdir output_images
          FILE="${{ steps.find_file.outputs.found_file }}"
          
          echo "Extrayendo..."
          ./tool_src/build/Release/cartool "$FILE" output_images/

      - name: 7. ðŸ“¦ Subir Resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Filtros-Dazz-Parcheados
          path: output_images/
