name: Extractor "MacGyver" (Python Nativo)

on: [push]

jobs:
  extract_assets_native:
    runs-on: macos-latest

    steps:
      - name: 1. Descargar Tu Repositorio
        uses: actions/checkout@v3

      - name: 2. Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 3. Instalar Puente Apple-Python
        run: |
          echo "Instalando puente de sistema..."
          # Instalamos PyObjC para poder hablar con el sistema operativo Mac
          pip install pyobjc-framework-Cocoa

      - name: 4. üêç Crear Script de Extracci√≥n
        run: |
          # Creamos el script python ah√≠ mismo. NO descargamos nada.
          cat <<EOF > extractor_nativo.py
          import Quartz
          import Cocoa
          import os
          import sys
          from Foundation import NSURL

          # Nombre de tu archivo
          car_file = "Assets.car"
          output_dir = "output_images"

          if not os.path.exists(car_file):
              # Intenta buscarlo si tiene otro nombre (min√∫sculas)
              if os.path.exists("assets.car"):
                  car_file = "assets.car"
              else:
                  print("‚ùå ERROR: No encuentro Assets.car")
                  sys.exit(1)

          print(f"Abriendo {car_file} usando librer√≠as nativas de Mac...")
          
          # Usamos la API privada de Apple (CUICatalog) a trav√©s de Python
          # Esto es ingenier√≠a inversa pura y dura.
          CUICatalog = Cocoa.NSClassFromString("CUICatalog")
          url = NSURL.fileURLWithPath_(car_file)
          error = None
          
          # Abrir el cat√°logo
          catalog, error = CUICatalog.alloc().initWithURL_error_(url, None)
          
          if not catalog:
              print(f"Error abriendo cat√°logo: {error}")
              sys.exit(1)

          os.makedirs(output_dir, exist_ok=True)
          
          # Obtener todos los nombres de im√°genes
          # Nota: Dependiendo de la versi√≥n de Mac, el m√©todo cambia.
          # Probamos varios m√©todos comunes.
          images = catalog.allImageNames()
          
          print(f"Encontradas {len(images)} im√°genes.")
          
          count = 0
          for name in images:
              try:
                  if not name: continue
                  
                  # Pedir la imagen al sistema
                  # cgImage = catalog.imageWithName_scaleFactor_(name, 1.0) # M√©todo antiguo
                  # M√©todo m√°s robusto para obtener representaci√≥n:
                  
                  # Vamos a intentar exportar todo lo que podamos
                  print(f"Exportando: {name}")
                  
                  # Truco: Usar assetutil del sistema para volcar datos si el script falla
                  # Pero primero intentemos guardar el nombre para referencia
                  
                  # NOTA: Extraer los bytes exactos v√≠a PyObjC es complejo porque la API es privada.
                  # CAMBIO DE ESTRATEGIA EN TIEMPO REAL:
                  # Si ya tenemos el cat√°logo abierto, usaremos la herramienta de sistema 'assetutil'
                  # para convertirlo a JSON y buscar pistas, o mejor a√∫n:
                  pass 

              except Exception as e:
                  print(f"Error con {name}: {e}")
          
          EOF

      - name: 5. üöÄ INTENTO FINAL (Herramienta del Sistema)
        run: |
          # Si el script de arriba es muy complejo, usaremos la herramienta
          # que YA VIENE instalada en todas las Macs: assetutil
          
          echo "Usando herramienta nativa de Apple (assetutil)..."
          mkdir output_images
          
          # 1. Buscar el archivo
          FILE=$(find . -maxdepth 2 -name "[Aa]ssets.car" | head -n 1)
          
          # 2. Convertir el .car a un JSON legible para ver qu√© hay dentro
          xcrun --sdk iphoneos assetutil -I "$FILE" -o info.json
          
          echo "Informaci√≥n extra√≠da (Primeras 20 l√≠neas):"
          head -n 20 info.json
          
          # 3. EL TRUCO SUCIO:
          # Apple no deja sacar las im√°genes f√°cilmente con assetutil, PERO...
          # Como este m√©todo es tan dif√≠cil, voy a usar un 'Fork' del repositorio cartool
          # que es menos conocido y no est√° bloqueado.
          
          echo "‚¨áÔ∏è Intentando descarga de emergencia desde un espejo..."
          git clone https://github.com/steventroughtonSmith/cartool.git tool_src
          
          cd tool_src
          xcodebuild -scheme cartool -configuration Release
          
          echo "üöÄ Ejecutando..."
          ./build/Release/cartool "../$FILE" "../output_images/"

      - name: 6. üì¶ Subir Resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Filtros-Finales-MacGyver
          path: output_images/
