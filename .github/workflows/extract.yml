name: Extractor V4 (Blindado)

on: [push]

jobs:
  extract_assets:
    runs-on: macos-latest
    permissions:
      contents: read

    steps:
      - name: 1. Descargar tu repositorio
        uses: actions/checkout@v3

      - name: 2. ðŸ›  Descargar herramienta (VÃ­a GH CLI + Token)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Usamos la herramienta oficial con tus credenciales temporales
          # Esto EVITA el error de "Device not configured" y el error del ZIP corrupto
          gh repo clone 0xced/cartool cartool_folder
          mv cartool_folder cartool

      - name: 3. ðŸ”¨ Compilar herramienta
        run: |
          cd cartool
          xcodebuild -scheme cartool -configuration Release

      - name: 4. ðŸ” Localizar Assets.car
        id: find_file
        run: |
          # Buscamos el archivo ignorando mayÃºsculas/minÃºsculas
          FILE=$(find . -maxdepth 2 -type f -name "[Aa]ssets.car" | head -n 1)
          
          if [ -z "$FILE" ]; then
             echo "âŒ NO ENCUENTRO EL ARCHIVO Assets.car"
             echo "Archivos disponibles:"
             ls -R
             exit 1
          fi
          
          echo "found_file=$FILE" >> $GITHUB_OUTPUT
          echo "âœ… Archivo encontrado: $FILE"

      - name: 5. ðŸš€ EJECUTAR EXTRACCIÃ“N
        run: |
          mkdir output_images
          FILE="${{ steps.find_file.outputs.found_file }}"
          
          # Ejecutamos la herramienta
          ./cartool/build/Release/cartool "$FILE" output_images/

      - name: 6. ðŸ“¦ Subir Resultados (ZIP)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Filtros-Finales
          path: output_images/
