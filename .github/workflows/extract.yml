name: Extractor V24 (Modo Agresivo)

on: [push]

jobs:
  extract_assets:
    runs-on: macos-latest

    steps:
      - name: 1. Descargar Tu Repositorio
        uses: actions/checkout@v3

      - name: 2. üèóÔ∏è Crear el c√≥digo del extractor
        run: |
          cat <<EOF > main.m
          #import <Foundation/Foundation.h>
          #import <CoreGraphics/CoreGraphics.h>
          #import <ImageIO/ImageIO.h>
          #import <CoreServices/CoreServices.h>

          // --- INTERFACES PRIVADAS ---
          @interface CUICatalog : NSObject
          -(instancetype)initWithURL:(NSURL *)url error:(NSError **)error;
          -(id)allImageNames;
          -(NSArray *)imagesWithName:(NSString *)n;
          @end

          @interface CUIThemeRendition : NSObject
          -(NSString *)name;
          -(CGImageRef)uncroppedImage; // M√©todo 1
          -(CGImageRef)image;          // M√©todo 2
          -(NSData *)data;             // M√©todo 3 (Raw data)
          @end

          int main(int argc, const char * argv[]) {
              @autoreleasepool {
                  if (argc < 3) return 1;

                  NSString *carPath = [NSString stringWithUTF8String:argv[1]];
                  NSString *outputDir = [NSString stringWithUTF8String:argv[2]];
                  
                  [[NSFileManager defaultManager] createDirectoryAtPath:outputDir withIntermediateDirectories:YES attributes:nil error:nil];

                  printf("--- INICIANDO EXTRACCI√ìN ---\n");
                  
                  NSError *error = nil;
                  NSBundle *bundle = [NSBundle bundleWithPath:@"/System/Library/PrivateFrameworks/CoreUI.framework"];
                  [bundle load];

                  NSURL *url = [NSURL fileURLWithPath:carPath];
                  id catalog = [[NSClassFromString(@"CUICatalog") alloc] initWithURL:url error:&error];

                  if (!catalog) {
                      printf("‚ùå Error abriendo cat√°logo: %s\n", [[error description] UTF8String]);
                      return 1;
                  }

                  NSArray *names = [catalog allImageNames];
                  printf("üìä Total en √≠ndice: %lu im√°genes.\n", (unsigned long)[names count]);

                  int exportedCount = 0;

                  for (NSString *name in names) {
                      printf("üîç Procesando: %s ... ", [name UTF8String]);
                      
                      @try {
                          NSArray *renditions = [catalog imagesWithName:name];
                          if (!renditions || [renditions count] == 0) {
                              printf("Sin variantes.\n");
                              continue;
                          }

                          // Tomamos la primera variante (rendition)
                          id rendition = renditions[0];
                          CGImageRef imageRef = nil;

                          // INTENTO 1: uncroppedImage
                          if ([rendition respondsToSelector:@selector(uncroppedImage)]) {
                              imageRef = [rendition uncroppedImage];
                          }
                          
                          // INTENTO 2: image (fallback)
                          if (!imageRef && [rendition respondsToSelector:@selector(image)]) {
                              imageRef = [rendition image];
                          }

                          if (imageRef) {
                              // Guardar como PNG
                              NSString *cleanName = [name stringByReplacingOccurrencesOfString:@"/" withString:@"_"];
                              NSString *fileName = [NSString stringWithFormat:@"%@/%@.png", outputDir, cleanName];
                              NSURL *fileURL = [NSURL fileURLWithPath:fileName];
                              
                              CGImageDestinationRef destination = CGImageDestinationCreateWithURL((__bridge CFURLRef)fileURL, (CFStringRef)@"public.png", 1, NULL);
                              
                              if (destination) {
                                  CGImageDestinationAddImage(destination, imageRef, nil);
                                  if (CGImageDestinationFinalize(destination)) {
                                      printf("‚úÖ OK (PNG)\n");
                                      exportedCount++;
                                  } else {
                                      printf("‚ùå Fallo al escribir archivo.\n");
                                  }
                                  CFRelease(destination);
                              }
                          } else {
                              printf("‚ö†Ô∏è No se pudo obtener imagen (es nula).\n");
                              
                              // INTENTO 3: Datos crudos (RAW DATA)
                              // Si no es una imagen normal, a lo mejor es un PDF o datos crudos
                              /*
                              if ([rendition respondsToSelector:@selector(data)]) {
                                  NSData *data = [rendition data];
                                  if (data) {
                                      NSString *cleanName = [name stringByReplacingOccurrencesOfString:@"/" withString:@"_"];
                                      NSString *fileName = [NSString stringWithFormat:@"%@/%@.bin", outputDir, cleanName];
                                      [data writeToFile:fileName atomically:YES];
                                      printf("üíæ Guardado como binario (.bin)\n");
                                      exportedCount++;
                                  }
                              }
                              */
                          }

                      } @catch (NSException *e) {
                          printf("üí• Excepci√≥n: %s\n", [[e reason] UTF8String]);
                      }
                  }
                  
                  printf("--- RESUMEN: Exportados %d de %lu ---\n", exportedCount, (unsigned long)[names count]);
              }
              return 0;
          }
          EOF

      - name: 3. üî® Compilar
        run: |
          clang -o extractor main.m -fobjc-arc \
            -framework Foundation \
            -framework CoreGraphics \
            -framework ImageIO \
            -framework CoreServices \
            -F /System/Library/PrivateFrameworks \
            -framework CoreUI

      - name: 4. üöÄ Extraer
        run: |
          FILE=$(find . -maxdepth 3 -type f -name "[Aa]ssets.car" | head -n 1)
          echo "Archivo: $FILE"
          
          ./extractor "$FILE" output_images/
          
          echo "Listado de archivos generados:"
          ls -l output_images/

      - name: 5. üì¶ Subir Resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Filtros-Dazz-V24
          path: output_images/
