name: Extractor V23 (Linker Fix)

on: [push]

jobs:
  extract_assets:
    runs-on: macos-latest

    steps:
      - name: 1. Descargar Tu Repositorio
        uses: actions/checkout@v3

      - name: 2. üèóÔ∏è Crear el c√≥digo del extractor
        run: |
          cat <<EOF > main.m
          #import <Foundation/Foundation.h>
          #import <CoreGraphics/CoreGraphics.h>
          #import <ImageIO/ImageIO.h>
          #import <CoreServices/CoreServices.h> // A√±adido header faltante

          // --- DEFINICIONES DE API PRIVADA (CoreUI) ---
          @interface CUICatalog : NSObject
          -(instancetype)initWithURL:(NSURL *)url error:(NSError **)error;
          -(id)allImageNames;
          -(NSArray *)imagesWithName:(NSString *)n;
          @end

          @interface CUIThemeRendition : NSObject
          -(NSString *)name;
          -(CGImageRef)uncroppedImage;
          @end

          int main(int argc, const char * argv[]) {
              @autoreleasepool {
                  if (argc < 3) {
                      printf("Uso: ./extractor <archivo.car> <carpeta_destino>\n");
                      return 1;
                  }

                  NSString *carPath = [NSString stringWithUTF8String:argv[1]];
                  NSString *outputDir = [NSString stringWithUTF8String:argv[2]];
                  
                  // Crear carpeta destino
                  [[NSFileManager defaultManager] createDirectoryAtPath:outputDir withIntermediateDirectories:YES attributes:nil error:nil];

                  printf("Abriendo: %s\n", [carPath UTF8String]);
                  
                  NSError *error = nil;
                  
                  // CARGAR COREUI MANUALMENTE
                  NSBundle *bundle = [NSBundle bundleWithPath:@"/System/Library/PrivateFrameworks/CoreUI.framework"];
                  if (![bundle load]) {
                      printf("Error: No se pudo cargar CoreUI.framework\n");
                      return 1;
                  }

                  // ABRIR CAT√ÅLOGO
                  NSURL *url = [NSURL fileURLWithPath:carPath];
                  Class CUICatalogClass = NSClassFromString(@"CUICatalog");
                  id catalog = [[CUICatalogClass alloc] initWithURL:url error:&error];

                  if (!catalog) {
                      printf("Error abriendo el .car (formato inv√°lido o corrupto).\n");
                      return 1;
                  }

                  // OBTENER IM√ÅGENES
                  NSArray *names = [catalog allImageNames];
                  printf("Encontradas %lu im√°genes.\n", (unsigned long)[names count]);

                  for (NSString *name in names) {
                      @try {
                          NSArray *renditions = [catalog imagesWithName:name];
                          
                          for (id rendition in renditions) {
                              if ([rendition respondsToSelector:@selector(uncroppedImage)]) {
                                  CGImageRef imageRef = [rendition uncroppedImage];
                                  
                                  if (imageRef) {
                                      NSString *cleanName = [name stringByReplacingOccurrencesOfString:@"/" withString:@"_"];
                                      NSString *fileName = [NSString stringWithFormat:@"%@/%@.png", outputDir, cleanName];
                                      NSURL *fileURL = [NSURL fileURLWithPath:fileName];
                                      
                                      // CORRECCI√ìN AQU√ç: Usamos string literal @"public.png" para evitar el error de kUTTypePNG
                                      CGImageDestinationRef destination = CGImageDestinationCreateWithURL((__bridge CFURLRef)fileURL, (CFStringRef)@"public.png", 1, NULL);
                                      
                                      if (destination) {
                                          CGImageDestinationAddImage(destination, imageRef, nil);
                                          CGImageDestinationFinalize(destination);
                                          CFRelease(destination);
                                          printf("Exportado: %s\n", [cleanName UTF8String]);
                                      }
                                  }
                              }
                          }
                      } @catch (NSException *e) {
                          // Ignorar errores puntuales
                      }
                  }
              }
              return 0;
          }
          EOF

      - name: 3. üî® Compilar Herramienta (Con todas las librer√≠as)
        run: |
          echo "Compilando extractor..."
          # A√ëADIMOS -framework CoreServices para que el Linker est√© feliz
          clang -o extractor main.m -fobjc-arc \
            -framework Foundation \
            -framework CoreGraphics \
            -framework ImageIO \
            -framework CoreServices \
            -F /System/Library/PrivateFrameworks \
            -framework CoreUI

      - name: 4. üîç Localizar y Extraer
        run: |
          FILE=$(find . -maxdepth 3 -type f -name "[Aa]ssets.car" | head -n 1)
          
          if [ -z "$FILE" ]; then
            echo "‚ùå ERROR: No encuentro Assets.car"
            exit 1
          fi
          
          echo "‚úÖ Archivo encontrado: $FILE"
          
          # Ejecutar
          ./extractor "$FILE" output_images/

      - name: 5. üì¶ Subir Resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Filtros-Finales-V23
          path: output_images/
