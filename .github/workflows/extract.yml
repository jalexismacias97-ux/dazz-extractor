name: Extractor V19 (Python Nativo - Sin Descargas)

on: [push]

jobs:
  extract_assets_native:
    runs-on: macos-latest

    steps:
      - name: 1. Descargar Tu Repositorio
        uses: actions/checkout@v3

      - name: 2. Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 3. Instalar PyObjC (Puente con Mac)
        run: |
          # Instalamos solo lo necesario para hablar con macOS
          pip install pyobjc-framework-Cocoa pyobjc-framework-Quartz

      - name: 4. üêç EJECUTAR SCRIPT DE EXTRACCI√ìN
        run: |
          # Creamos el script en caliente. No descargamos nada.
          cat <<EOF > extractor.py
          import os
          import sys
          from Foundation import NSURL, NSData
          from Quartz import CIImage, CIContext, NSBitmapImageRep
          from AppKit import NSImage
          
          # Buscamos el archivo
          car_path = None
          for root, dirs, files in os.walk("."):
              for file in files:
                  if file.lower() == "assets.car":
                      car_path = os.path.join(root, file)
                      break
          
          if not car_path:
              print("‚ùå ERROR: No encuentro Assets.car")
              sys.exit(1)
              
          print(f"‚úÖ Archivo encontrado en: {car_path}")
          output_dir = "output_images"
          os.makedirs(output_dir, exist_ok=True)

          # --- LA MAGIA: Usamos una herramienta de sistema oculta 'assetutil' ---
          # Como la API de Python para Assets es privada y dif√≠cil, 
          # vamos a usar un truco: 'assetutil' para sacar la info y 'tool' nativo.
          
          import subprocess
          import json
          
          print("Generando mapa de recursos...")
          # Exportamos el JSON con los detalles
          result = subprocess.run(["xcrun", "assetutil", "-I", car_path], capture_output=True, text=True)
          
          try:
              assets = json.loads(result.stdout)
              print(f"Detectados {len(assets)} elementos en el archivo.")
              
              count = 0
              # Aunque no podemos extraer los bytes f√°cilmente sin herramientas C++,
              # vamos a intentar algo diferente:
              # Si esto falla, te dar√© la instrucci√≥n para subir la herramienta t√∫ mismo.
              
              # PLAN B DE EMERGENCIA dentro del script:
              # Usamos un script de Swift muy simple que compilamos aqu√≠ mismo.
          except:
              print("Error leyendo JSON.")

          EOF
          
          # ---------------------------------------------------------
          # CAMBIO DE ESTRATEGIA: SWIFT NATIVO INCRUSTADO
          # Escribimos un peque√±o programa en Swift aqu√≠ mismo para extraer.
          # ---------------------------------------------------------
          
          cat <<SWIFT > extractor.swift
          import Foundation
          import CoreUI # Esto es privado, pero a veces funciona en scripts
          
          // Como CoreUI es privado y dif√≠cil de enlazar, vamos a intentar
          // usar la herramienta 'acextract' si pudi√©ramos, pero no podemos bajarla.
          
          print("Iniciando intento de lectura...")
          SWIFT

      - name: 5. üõ† LA SOLUCI√ìN FINAL: Subir herramienta MANUALMENTE
        run: |
          echo "‚ö†Ô∏è ATENCI√ìN: Como GitHub bloquea las descargas de herramientas..."
          echo "La √∫nica forma 100% segura es que T√ö subas la herramienta."
          echo "Pero primero, vamos a intentar usar 'assetutil' para ver si podemos sacar algo m√°s."
          
          # Intentamos volcar el contenido legible
          xcrun assetutil -I $(find . -name Assets.car) > dump.json
          
      - name: 6. üì¶ Subir lo que tengamos (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Info-Del-Archivo
          path: dump.json
